#!/usr/bin/env node

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  console.log('‚ùå Supabase credentials not found in environment variables');
  console.log('Please set SUPABASE_URL and SUPABASE_ANON_KEY in your .env file');
  process.exit(1);
}

console.log('üîß Setting up Supabase database...');
console.log(`üìç URL: ${SUPABASE_URL}`);

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function setupDatabase() {
  try {
    // SQL to create the table and policies
    const setupSQL = `
-- Create table for generated files
CREATE TABLE IF NOT EXISTS generated_files (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  access_key VARCHAR(32) UNIQUE NOT NULL,
  discord_user_id VARCHAR(255) NOT NULL,
  discord_username VARCHAR(255),
  steam_app_id INTEGER NOT NULL,
  steam_app_name TEXT NOT NULL,
  manifest_content TEXT NOT NULL,
  lua_content TEXT NOT NULL,
  manifest_size INTEGER NOT NULL,
  lua_size INTEGER NOT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create index for faster lookups
CREATE INDEX IF NOT EXISTS idx_generated_files_access_key ON generated_files(access_key);
CREATE INDEX IF NOT EXISTS idx_generated_files_expires_at ON generated_files(expires_at);

-- Enable Row Level Security (RLS)
ALTER TABLE generated_files ENABLE ROW LEVEL SECURITY;

-- Create policy for public read access with access key
CREATE POLICY "Public read access with access key" ON generated_files
  FOR SELECT USING (true);

-- Create policy for insertions (anyone can insert)
CREATE POLICY "Allow insertions" ON generated_files
  FOR INSERT WITH CHECK (true);

-- Create policy for deletions (anyone can delete expired files)
CREATE POLICY "Allow deletions" ON generated_files
  FOR DELETE USING (true);

-- Function to automatically clean up expired files
CREATE OR REPLACE FUNCTION cleanup_expired_files()
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  DELETE FROM generated_files 
  WHERE expires_at < NOW();
END;
$$;
    `;

    console.log('üöÄ Executing database setup...');
    
    // Execute the SQL using Supabase RPC
    const { data, error } = await supabase.rpc('exec_sql', { sql: setupSQL });
    
    if (error) {
      console.log('‚ö†Ô∏è  RPC method not available, trying direct SQL...');
      
      // Try using raw SQL execution (this might not work with all Supabase setups)
      console.log('üìù Please run this SQL manually in your Supabase SQL Editor:');
      console.log('\n' + '='.repeat(60));
      console.log(setupSQL);
      console.log('='.repeat(60) + '\n');
      console.log('üîó Go to: https://xybrjrecphoavhtvcsnn.supabase.co/project/_/sql');
      
    } else {
      console.log('‚úÖ Database setup completed successfully!');
    }

    // Test the connection
    console.log('üß™ Testing database connection...');
    const { data: testData, error: testError } = await supabase
      .from('generated_files')
      .select('count')
      .limit(1);

    if (testError) {
      console.log('‚ùå Connection test failed:', testError.message);
    } else {
      console.log('‚úÖ Database connection successful!');
    }

  } catch (error) {
    console.error('‚ùå Setup failed:', error.message);
  }
}

setupDatabase();